name: Build and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: bot
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Scraper image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: scraper
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/scraper:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e

            # ConfiguraciÃ³n
            APP_DIR="${{ secrets.APP_DIR }}"
            REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

            echo "ğŸ“¦ Iniciando despliegue..."

            # Login en GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull de imÃ¡genes nuevas
            docker pull ghcr.io/${{ github.repository }}/bot:latest
            docker pull ghcr.io/${{ github.repository }}/scraper:latest

            # Preparar directorio
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Actualizar cÃ³digo
            if [ -d ".git" ]; then
              git remote set-url origin "$REPO_URL"
              git fetch origin main
              git reset --hard origin/main
            else
              git clone "$REPO_URL" .
            fi

            # Crear archivo .env
            cat > .env << EOF
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            IMAGE_REPO=${{ secrets.IMAGE_REPO }}
            EOF

            # Detectar docker compose
            if docker compose version >/dev/null 2>&1; then
              DC="docker compose"
            else
              DC="docker-compose"
            fi

            # Reiniciar servicios (preservando volÃºmenes)
            echo "ğŸ”„ Reiniciando servicios..."
            $DC down || true
            $DC up -d

            # Esperar a que los servicios estÃ©n listos
            echo "â³ Esperando a que los servicios estÃ©n listos..."
            sleep 15

            # Verificar estado
            echo "âœ… Estado de los contenedores:"
            docker ps --format "table {{.Names}}\t{{.Status}}"

            # Limpieza
            docker image prune -f

            echo "ğŸ‰ Despliegue completado!"
