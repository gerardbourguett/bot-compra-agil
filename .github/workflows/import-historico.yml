name: Importar Hist√≥rico Mensual

on:
  schedule:
    - cron: '0 6 1 * *'
  workflow_dispatch:
    inputs:
      month:
        description: Mes a importar (YYYY-MM)
        required: false
        type: string
      force:
        description: Forzar importaci√≥n aunque existan datos
        required: false
        type: boolean

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 horas m√°ximo
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "üì¶ Instalando dependencias..."
          pip install -r requirements.txt
          echo "‚úì Dependencias instaladas"

      - name: Validar variables de entorno
        run: |
          echo "üîç Validando configuraci√≥n..."
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå ERROR: DATABASE_URL no est√° configurada"
            exit 1
          fi
          echo "‚úì DATABASE_URL configurada"
          echo "‚úì Variables de entorno validadas"

      - name: Verificar conexi√≥n a base de datos
        run: |
          echo "üîó Verificando conexi√≥n a PostgreSQL..."
          python -c "
          import os
          import psycopg2
          try:
              conn = psycopg2.connect(os.environ['DATABASE_URL'])
              cursor = conn.cursor()
              cursor.execute('SELECT version();')
              version = cursor.fetchone()[0]
              print(f'‚úì Conexi√≥n exitosa a PostgreSQL')
              print(f'  Versi√≥n: {version}')
              conn.close()
          except Exception as e:
              print(f'‚ùå Error de conexi√≥n: {e}')
              exit(1)
          "

      - name: Mostrar informaci√≥n del archivo (scheduled)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "üìÖ Importaci√≥n programada - Mes anterior"
          MONTH=$(python -c "from datetime import datetime, timedelta; prev = (datetime.utcnow().replace(day=1) - timedelta(days=1)); print(f'{prev.year}-{prev.month:02d}')")
          URL="https://transparenciachc.blob.core.windows.net/trnspchc/COT_${MONTH}.zip"
          echo "  Mes: $MONTH"
          echo "  URL: $URL"

      - name: Mostrar informaci√≥n del archivo (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üéØ Importaci√≥n manual"
          if [ -n "${{ inputs.month }}" ]; then
            echo "  Mes especificado: ${{ inputs.month }}"
            URL="https://transparenciachc.blob.core.windows.net/trnspchc/COT_${{ inputs.month }}.zip"
          else
            MONTH=$(python -c "from datetime import datetime, timedelta; prev = (datetime.utcnow().replace(day=1) - timedelta(days=1)); print(f'{prev.year}-{prev.month:02d}')")
            echo "  Mes (por defecto): $MONTH"
            URL="https://transparenciachc.blob.core.windows.net/trnspchc/COT_${MONTH}.zip"
          fi
          echo "  URL: $URL"
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "  ‚ö†Ô∏è  Modo forzado: Se importar√° aunque existan datos"
          fi

      - name: Import last month
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "üöÄ Inicio de importaci√≥n autom√°tica"
          echo "=================================================="
          cd src
          python run_monthly_import.py
          echo "=================================================="

      - name: Import specified month
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üöÄ Inicio de importaci√≥n manual"
          echo "=================================================="
          FORCE_FLAG=""
          if [ "${{ inputs.force }}" = "true" ]; then FORCE_FLAG="--force"; fi
          cd src
          python run_monthly_import.py --month "${{ inputs.month }}" $FORCE_FLAG
          echo "=================================================="

      - name: Resumen de ejecuci√≥n
        if: always()
        run: |
          echo ""
          echo "üìä RESUMEN DE EJECUCI√ìN"
          echo "=================================================="
          echo "Estado del job: ${{ job.status }}"
          echo "Tipo de ejecuci√≥n: ${{ github.event_name }}"
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Importaci√≥n completada exitosamente"
          else
            echo "‚ùå La importaci√≥n fall√≥ - Revisar logs arriba"
          fi
          echo "=================================================="
