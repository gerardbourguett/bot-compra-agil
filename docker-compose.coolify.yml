# =============================================================================
# Docker Compose para Coolify - CompraAgil
# =============================================================================
# PostgreSQL y Redis se configuran como "Databases" separadas en Coolify.
# Este archivo define solo los servicios de aplicacion (api, bot, scraper).
#
# CONFIGURACION DE RED EN COOLIFY:
# --------------------------------
# Coolify crea una red automatica por proyecto. PostgreSQL y Redis estan en
# la red "coolify". Para que los servicios puedan conectarse, este compose
# conecta cada servicio a AMBAS redes:
#   1. La red del proyecto (creada automaticamente por Coolify)
#   2. La red "coolify" (donde estan PostgreSQL y Redis)
#
# VARIABLES DE ENTORNO REQUERIDAS:
# --------------------------------
# DATABASE_URL: postgresql://user:pass@CONTAINER_ID:5432/dbname
# REDIS_URL: redis://CONTAINER_ID:6379/0
# TELEGRAM_TOKEN: Token del bot de Telegram
# GEMINI_API_KEY: API key de Google Gemini
#
# El CONTAINER_ID se obtiene de Coolify UI (ej: hkcso0gwgwc08gs48sc4sw84)
# =============================================================================

services:
  # ============================================
  # API REST - Puerto 8001
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    ports:
      - "8001:8001"
    volumes:
      - api_logs:/app/logs
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "coolify.managed=true"
      - "coolify.type=api"

  # ============================================
  # Bot de Telegram
  # ============================================
  bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: bot
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - bot_logs:/app/logs
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'bot_inteligente.py' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "coolify.managed=true"
      - "coolify.type=bot"

  # ============================================
  # Scraper (ejecuta cada 60/120 min)
  # ============================================
  scraper:
    build:
      context: .
      dockerfile: Dockerfile
      target: scraper
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - scraper_logs:/app/logs
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'scheduler.py' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "coolify.managed=true"
      - "coolify.type=scraper"

volumes:
  api_logs:
    driver: local
  bot_logs:
    driver: local
  scraper_logs:
    driver: local

# Redes: cada servicio se conecta a ambas redes
networks:
  default:
    # Red del proyecto (Coolify la nombra automaticamente)
  coolify:
    # Red donde estan PostgreSQL y Redis
    external: true
