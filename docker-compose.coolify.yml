# Docker Compose para Coolify - Servicios Separados
# PostgreSQL y Redis se configuran directamente en Coolify como Databases
# Este archivo define solo los servicios de aplicacion

services:
  # ============================================
  # API REST - Puerto 8001
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    container_name: compra_agil_api
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    ports:
      - "8001:8001"
    volumes:
      - api_logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "coolify.managed=true"
      - "coolify.type=api"

  # ============================================
  # Bot de Telegram
  # ============================================
  bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: bot
    container_name: compra_agil_bot
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - bot_logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'bot_inteligente.py' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "coolify.managed=true"
      - "coolify.type=bot"

  # ============================================
  # Scraper (ejecuta cada 6 horas)
  # ============================================
  scraper:
    build:
      context: .
      dockerfile: Dockerfile
      target: scraper
    container_name: compra_agil_scraper
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - scraper_logs:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'scheduler.py' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "coolify.managed=true"
      - "coolify.type=scraper"

volumes:
  api_logs:
    driver: local
  bot_logs:
    driver: local
  scraper_logs:
    driver: local
